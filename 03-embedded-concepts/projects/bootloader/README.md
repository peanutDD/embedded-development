# 简单 Bootloader 项目

这个项目演示了如何在 STM32F4 微控制器上实现一个简单的 bootloader 系统。

## 项目结构

```
bootloader/
├── src/
│   ├── bootloader.rs      # Bootloader 主程序
│   └── application.rs     # 示例应用程序
├── memory-bootloader.x    # Bootloader 内存布局
├── memory-app.x          # 应用程序内存布局
├── build.rs              # 构建脚本
├── Cargo.toml            # 项目配置
└── README.md             # 说明文档
```

## 内存布局

### Bootloader (0x08000000 - 0x08007FFF, 32KB)
- 向量表
- Bootloader 代码
- 启动逻辑
- 固件更新功能

### Application (0x08008000 - 0x0807FFFF, 480KB)
- 应用程序向量表
- 应用程序代码
- 应用程序数据

## 功能特性

### Bootloader 功能
1. **应用程序验证**
   - 魔数检查
   - CRC32 校验
   - 大小验证
   - 入口点验证

2. **启动模式选择**
   - 按钮强制进入 bootloader 模式
   - 应用程序无效时自动进入 bootloader 模式
   - 正常启动应用程序

3. **固件更新**
   - Flash 擦除和编程
   - 数据完整性验证
   - 更新状态指示

4. **错误处理**
   - 不同错误类型的 LED 指示
   - 安全的错误恢复
   - 系统重启功能

### 应用程序功能
1. **应用程序头部**
   - 包含版本信息
   - CRC32 校验和
   - 入口点地址

2. **运行时功能**
   - LED 闪烁指示
   - 周期性任务执行
   - 状态监控

## 构建和使用

### 构建 Bootloader
```bash
cargo build --bin bootloader --release
```

### 构建应用程序
```bash
cargo build --bin application --release
```

### 烧录步骤
1. 首先烧录 bootloader 到 0x08000000
2. 然后烧录应用程序到 0x08008000

### 使用方法
1. **正常启动**: 上电后自动检查并启动应用程序
2. **强制 bootloader**: 按住用户按钮上电进入 bootloader 模式
3. **更新固件**: 在 bootloader 模式下通过串口/USB 更新固件

## LED 指示说明

### Bootloader 模式
- **快速闪烁 6 次**: Bootloader 启动
- **慢速闪烁**: 等待固件更新
- **快速闪烁 20 次**: 正在更新固件

### 错误指示
- **3 次短闪**: 应用程序无效
- **4 次短闪**: 栈指针无效
- **5 次短闪**: 复位向量无效

### 应用程序模式
- **3 次长闪**: 应用程序启动
- **规律闪烁**: 正常运行
- **5 次快闪**: 执行特殊任务

## 安全特性

1. **应用程序验证**
   - 启动前完整性检查
   - CRC32 校验防止损坏
   - 地址范围验证

2. **Flash 保护**
   - Bootloader 区域写保护
   - 安全的 Flash 操作
   - 错误恢复机制

3. **故障处理**
   - 硬件故障捕获
   - 安全的系统重启
   - 错误状态记录

## 扩展功能

可以在此基础上添加：

1. **通信接口**
   - UART 固件更新
   - USB DFU 模式
   - CAN 总线更新
   - 以太网更新

2. **安全功能**
   - 固件签名验证
   - 加密固件支持
   - 安全启动

3. **高级特性**
   - 双备份系统
   - 增量更新
   - 回滚功能
   - 远程更新

## 注意事项

1. **内存对齐**: 确保所有地址都是 4 字节对齐
2. **向量表**: 应用程序必须正确设置向量表偏移
3. **栈指针**: 验证栈指针在有效的 RAM 范围内
4. **中断**: 跳转前禁用所有中断
5. **时钟**: 应用程序需要重新配置时钟系统

## 调试技巧

1. **使用调试器**: 设置断点查看启动过程
2. **LED 指示**: 通过 LED 模式判断系统状态
3. **内存查看**: 检查应用程序头部和数据
4. **寄存器状态**: 查看 SCB.VTOR 等关键寄存器
5. **Flash 内容**: 验证 Flash 中的数据完整性