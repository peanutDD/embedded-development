# æ™ºèƒ½äº¤é€šç¯ç³»ç»Ÿ

è¿™ä¸ªé¡¹ç›®å®žçŽ°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„æ™ºèƒ½äº¤é€šç¯æŽ§åˆ¶ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§å·¥ä½œæ¨¡å¼å’Œæ™ºèƒ½æŽ§åˆ¶åŠŸèƒ½ã€‚ç³»ç»Ÿé‡‡ç”¨çŠ¶æ€æœºè®¾è®¡ï¼Œå…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ðŸš¦ æ ¸å¿ƒåŠŸèƒ½
- **å¤šè·¯äº¤é€šæŽ§åˆ¶**: æ”¯æŒä¸»è·¯å’Œè¾…è·¯çš„ç‹¬ç«‹äº¤é€šç¯æŽ§åˆ¶
- **è¡Œäººè¿‡è¡—ç³»ç»Ÿ**: é›†æˆè¡Œäººä¿¡å·ç¯å’ŒæŒ‰é’®è¯·æ±‚åŠŸèƒ½
- **æ™ºèƒ½æ—¶åºæŽ§åˆ¶**: å¯é…ç½®çš„ç»¿ç¯ã€é»„ç¯ã€çº¢ç¯æŒç»­æ—¶é—´
- **çŠ¶æ€æœºé©±åŠ¨**: åŸºäºŽçŠ¶æ€æœºçš„å¯é çŠ¶æ€è½¬æ¢

### ðŸŒ™ å·¥ä½œæ¨¡å¼
- **æ­£å¸¸æ¨¡å¼**: æ ‡å‡†çš„äº¤é€šç¯å¾ªçŽ¯æŽ§åˆ¶
- **å¤œé—´æ¨¡å¼**: ä¸»è·¯é—ªçƒé»„ç¯ï¼Œè¾…è·¯çº¢ç¯
- **ç´§æ€¥æ¨¡å¼**: æ‰€æœ‰æ–¹å‘é—ªçƒé»„ç¯
- **ç»´æŠ¤æ¨¡å¼**: ç³»ç»Ÿç»´æŠ¤æ—¶çš„å®‰å…¨çŠ¶æ€

### ðŸŽ›ï¸ äº¤äº’æŽ§åˆ¶
- **è¡ŒäººæŒ‰é’®**: è¯·æ±‚è¡Œäººè¿‡è¡—ä¿¡å·
- **ç´§æ€¥æŒ‰é’®**: åˆ‡æ¢ç´§æ€¥æ¨¡å¼
- **å¤œé—´æ¨¡å¼æŒ‰é’®**: æ‰‹åŠ¨åˆ‡æ¢å¤œé—´æ¨¡å¼
- **çŠ¶æ€æŒ‡ç¤ºç¯**: æ˜¾ç¤ºå½“å‰ç³»ç»Ÿå·¥ä½œçŠ¶æ€

### ðŸ“Š ç³»ç»Ÿç›‘æŽ§
- **å®žæ—¶ç»Ÿè®¡**: è®°å½•ç³»ç»Ÿè¿è¡Œç»Ÿè®¡ä¿¡æ¯
- **RTTè°ƒè¯•è¾“å‡º**: è¯¦ç»†çš„çŠ¶æ€å’Œäº‹ä»¶æ—¥å¿—
- **æ€§èƒ½ç›‘æŽ§**: å‘¨æœŸè®¡æ•°å’Œäº‹ä»¶ç»Ÿè®¡

## ç¡¬ä»¶è¿žæŽ¥

### ä¸»è·¯äº¤é€šç¯ (STM32F407)
```
PA0 ----[220Î©]---- ä¸»è·¯çº¢ç¯LED ---- GND
PA1 ----[220Î©]---- ä¸»è·¯é»„ç¯LED ---- GND  
PA2 ----[220Î©]---- ä¸»è·¯ç»¿ç¯LED ---- GND
```

### è¾…è·¯äº¤é€šç¯
```
PA3 ----[220Î©]---- è¾…è·¯çº¢ç¯LED ---- GND
PA4 ----[220Î©]---- è¾…è·¯é»„ç¯LED ---- GND
PA5 ----[220Î©]---- è¾…è·¯ç»¿ç¯LED ---- GND
```

### è¡Œäººä¿¡å·ç¯
```
PB0 ----[220Î©]---- è¡Œäººçº¢ç¯LED ---- GND
PB1 ----[220Î©]---- è¡Œäººç»¿ç¯LED ---- GND
```

### çŠ¶æ€æŒ‡ç¤ºç¯
```
PB2 ----[220Î©]---- æ­£å¸¸çŠ¶æ€LED ---- GND
PB3 ----[220Î©]---- ç´§æ€¥çŠ¶æ€LED ---- GND
PB4 ----[220Î©]---- å¤œé—´çŠ¶æ€LED ---- GND
```

### æŽ§åˆ¶æŒ‰é’®
```
PC13 ---- è¡ŒäººæŒ‰é’® ---- GND (å†…éƒ¨ä¸Šæ‹‰)
PC14 ---- ç´§æ€¥æŒ‰é’® ---- GND (å†…éƒ¨ä¸Šæ‹‰)
PC15 ---- å¤œé—´æ¨¡å¼æŒ‰é’® ---- GND (å†…éƒ¨ä¸Šæ‹‰)
```

## ç³»ç»Ÿæž¶æž„

### çŠ¶æ€æœºè®¾è®¡

#### æ­£å¸¸æ¨¡å¼çŠ¶æ€è½¬æ¢
```
MainGreen â†’ MainYellow â†’ SideGreen â†’ SideYellow â†’ MainGreen
     â†“
PedestrianWait â†’ PedestrianCross â†’ MainGreen
```

#### æ—¶åºé…ç½®
```rust
const GREEN_DURATION_MS: u32 = 5000;    // ç»¿ç¯5ç§’
const YELLOW_DURATION_MS: u32 = 2000;   // é»„ç¯2ç§’  
const RED_DURATION_MS: u32 = 3000;      // çº¢ç¯3ç§’
const PEDESTRIAN_CROSS_MS: u32 = 8000;  // è¡Œäººé€šè¡Œ8ç§’
```

### æ ¸å¿ƒç»„ä»¶

1. **TrafficLightController**: ä¸»æŽ§åˆ¶å™¨
   - ç®¡ç†æ‰€æœ‰äº¤é€šç¯çŠ¶æ€
   - å¤„ç†çŠ¶æ€è½¬æ¢é€»è¾‘
   - æŽ§åˆ¶é—ªçƒæ•ˆæžœ

2. **SystemState**: ç³»ç»ŸçŠ¶æ€ç®¡ç†
   - è·Ÿè¸ªå½“å‰å·¥ä½œæ¨¡å¼
   - å¤„ç†è¡Œäººè¯·æ±‚
   - ç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯

3. **ButtonManager**: æŒ‰é’®è¾“å…¥ç®¡ç†
   - æ£€æµ‹æŒ‰é’®æŒ‰ä¸‹äº‹ä»¶
   - é˜²æŠ–å¤„ç†
   - è¾¹æ²¿æ£€æµ‹

4. **å„ç±»ç¯å…‰æŽ§åˆ¶ç»“æž„ä½“**:
   - `MainTrafficLights`: ä¸»è·¯äº¤é€šç¯
   - `SideTrafficLights`: è¾…è·¯äº¤é€šç¯
   - `PedestrianLights`: è¡Œäººä¿¡å·ç¯
   - `StatusLights`: çŠ¶æ€æŒ‡ç¤ºç¯

## å·¥ä½œæµç¨‹

### æ­£å¸¸æ¨¡å¼å¾ªçŽ¯
1. **ä¸»è·¯ç»¿ç¯é˜¶æ®µ** (5ç§’)
   - ä¸»è·¯: ç»¿ç¯
   - è¾…è·¯: çº¢ç¯
   - è¡Œäºº: çº¢ç¯

2. **ä¸»è·¯é»„ç¯é˜¶æ®µ** (2ç§’)
   - ä¸»è·¯: é»„ç¯
   - è¾…è·¯: çº¢ç¯
   - è¡Œäºº: çº¢ç¯

3. **è¾…è·¯ç»¿ç¯é˜¶æ®µ** (5ç§’)
   - ä¸»è·¯: çº¢ç¯
   - è¾…è·¯: ç»¿ç¯
   - è¡Œäºº: çº¢ç¯

4. **è¾…è·¯é»„ç¯é˜¶æ®µ** (2ç§’)
   - ä¸»è·¯: çº¢ç¯
   - è¾…è·¯: é»„ç¯
   - è¡Œäºº: çº¢ç¯

### è¡Œäººè¿‡è¡—æµç¨‹
1. **è¡ŒäººæŒ‰é’®æŒ‰ä¸‹**
   - ç³»ç»Ÿè®°å½•è¡Œäººè¯·æ±‚
   - ç­‰å¾…å½“å‰ç»¿ç¯é˜¶æ®µç»“æŸ

2. **è¡Œäººç­‰å¾…é˜¶æ®µ** (1ç§’)
   - æ‰€æœ‰è½¦è¾†: çº¢ç¯
   - è¡Œäºº: çº¢ç¯

3. **è¡Œäººé€šè¡Œé˜¶æ®µ** (8ç§’)
   - æ‰€æœ‰è½¦è¾†: çº¢ç¯
   - è¡Œäºº: ç»¿ç¯
   - æœ€åŽ3ç§’ç»¿ç¯é—ªçƒæé†’

### ç‰¹æ®Šæ¨¡å¼

#### å¤œé—´æ¨¡å¼
- ä¸»è·¯: é—ªçƒé»„ç¯ (1ç§’é—´éš”)
- è¾…è·¯: çº¢ç¯
- è¡Œäºº: çº¢ç¯

#### ç´§æ€¥æ¨¡å¼
- æ‰€æœ‰æ–¹å‘: é—ªçƒé»„ç¯ (0.5ç§’é—´éš”)
- è¡Œäºº: å…³é—­

#### ç»´æŠ¤æ¨¡å¼
- æ‰€æœ‰ç¯å…‰: 2ç§’é—´éš”é—ªçƒçº¢ç¯

## ç¼–è¯‘å’Œè¿è¡Œ

### 1. ç¼–è¯‘é¡¹ç›®
```bash
cd 04-gpio-control/projects/traffic-light
cargo build
```

### 2. çƒ§å½•åˆ°ç¡¬ä»¶
```bash
cargo run
```

### 3. æŸ¥çœ‹è°ƒè¯•è¾“å‡º
```bash
probe-rs rtt --chip STM32F407VGTx
```

## è°ƒè¯•è¾“å‡ºç¤ºä¾‹

### ç³»ç»Ÿå¯åŠ¨
```
æ™ºèƒ½äº¤é€šç¯ç³»ç»Ÿå¯åŠ¨
ç³»ç»Ÿæ—¶é’Ÿé…ç½®å®Œæˆ: SYSCLK=168MHz
äº¤é€šç¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
å¼€å§‹äº¤é€šç¯æŽ§åˆ¶å¾ªçŽ¯
```

### æ­£å¸¸è¿è¡Œ
```
çŠ¶æ€è½¬æ¢: MainGreen -> MainYellow
çŠ¶æ€è½¬æ¢: MainYellow -> SideGreen
çŠ¶æ€è½¬æ¢: SideGreen -> SideYellow
çŠ¶æ€è½¬æ¢: SideYellow -> MainGreen
è¿è¡Œç»Ÿè®¡: å‘¨æœŸ=1, æ—¶é—´=10000ms, æ¨¡å¼=Normal
ç»Ÿè®¡ä¿¡æ¯: æ­£å¸¸å‘¨æœŸ=4, è¡Œäººè¯·æ±‚=0, ç´§æ€¥äº‹ä»¶=0
```

### è¡Œäººè¯·æ±‚
```
è¡ŒäººæŒ‰é’®æŒ‰ä¸‹
çŠ¶æ€è½¬æ¢: MainGreen -> MainYellow
çŠ¶æ€è½¬æ¢: MainYellow -> PedestrianWait
çŠ¶æ€è½¬æ¢: PedestrianWait -> PedestrianCross
çŠ¶æ€è½¬æ¢: PedestrianCross -> MainGreen
```

### æ¨¡å¼åˆ‡æ¢
```
ç´§æ€¥æŒ‰é’®æŒ‰ä¸‹
è¿›å…¥ç´§æ€¥æ¨¡å¼
å¤œé—´æ¨¡å¼æŒ‰é’®æŒ‰ä¸‹
è¿›å…¥å¤œé—´æ¨¡å¼
```

## é…ç½®å‚æ•°

### æ—¶åºå‚æ•°
```rust
// åŸºç¡€æ—¶åº
const GREEN_DURATION_MS: u32 = 5000;
const YELLOW_DURATION_MS: u32 = 2000;
const RED_DURATION_MS: u32 = 3000;

// è¡Œäººæ—¶åº
const PEDESTRIAN_WAIT_MS: u32 = 1000;
const PEDESTRIAN_CROSS_MS: u32 = 8000;

// ç‰¹æ®Šæ¨¡å¼æ—¶åº
const NIGHT_MODE_BLINK_MS: u32 = 1000;
const EMERGENCY_BLINK_MS: u32 = 500;
```

### ç³»ç»Ÿå‚æ•°
```rust
const SYSTEM_CLOCK_HZ: u32 = 168_000_000;
const TIMER_FREQUENCY_HZ: u32 = 1000;
```

## æ‰©å±•åŠŸèƒ½

### 1. è‡ªåŠ¨æ—¶é—´æŽ§åˆ¶
æ·»åŠ RTCæ¨¡å—ï¼Œå®žçŽ°åŸºäºŽæ—¶é—´çš„è‡ªåŠ¨æ¨¡å¼åˆ‡æ¢ï¼š

```rust
// è‡ªåŠ¨å¤œé—´æ¨¡å¼
if current_hour >= NIGHT_MODE_START_HOUR || current_hour < NIGHT_MODE_END_HOUR {
    system_state.set_night_mode();
}
```

### 2. è½¦æµé‡æ£€æµ‹
é›†æˆä¼ æ„Ÿå™¨æ£€æµ‹è½¦æµé‡ï¼ŒåŠ¨æ€è°ƒæ•´ç»¿ç¯æ—¶é—´ï¼š

```rust
let traffic_density = sensor.read_traffic_density();
let green_duration = calculate_green_duration(traffic_density);
```

### 3. ç½‘ç»œè¿žæŽ¥
æ·»åŠ WiFi/ä»¥å¤ªç½‘æ¨¡å—ï¼Œå®žçŽ°è¿œç¨‹ç›‘æŽ§å’ŒæŽ§åˆ¶ï¼š

```rust
// å‘é€çŠ¶æ€åˆ°æœåŠ¡å™¨
network.send_status(system_state.get_statistics());

// æŽ¥æ”¶è¿œç¨‹æŽ§åˆ¶å‘½ä»¤
if let Some(command) = network.receive_command() {
    system_state.process_remote_command(command);
}
```

### 4. å£°éŸ³æç¤º
æ·»åŠ èœ‚é¸£å™¨ï¼Œä¸ºè§†éšœäººå£«æä¾›å£°éŸ³æç¤ºï¼š

```rust
// è¡Œäººé€šè¡Œå£°éŸ³æç¤º
if pedestrian_crossing {
    buzzer.play_crossing_sound();
}
```

## å®‰å…¨ç‰¹æ€§

### 1. æ•…éšœæ£€æµ‹
- LEDæ•…éšœæ£€æµ‹
- æŒ‰é’®æ•…éšœæ£€æµ‹
- ç³»ç»Ÿå¥åº·ç›‘æŽ§

### 2. å®‰å…¨çŠ¶æ€
- æ•…éšœæ—¶è‡ªåŠ¨è¿›å…¥å®‰å…¨æ¨¡å¼
- æ‰€æœ‰æ–¹å‘çº¢ç¯æˆ–é—ªçƒé»„ç¯
- æ•…éšœçŠ¶æ€æŒ‡ç¤º

### 3. çœ‹é—¨ç‹—
- ç³»ç»Ÿæ­»é”æ£€æµ‹
- è‡ªåŠ¨é‡å¯æœºåˆ¶
- çŠ¶æ€æ¢å¤

## æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ä¼˜åŒ–
- ä½¿ç”¨æ ˆä¸Šæ•°æ®ç»“æž„
- é¿å…åŠ¨æ€å†…å­˜åˆ†é…
- ä¼˜åŒ–æ•°æ®ç»“æž„å¤§å°

### 2. å®žæ—¶æ€§ä¼˜åŒ–
- ä¸­æ–­é©±åŠ¨çš„æŒ‰é’®æ£€æµ‹
- é«˜ç²¾åº¦å®šæ—¶å™¨
- ä¼˜å…ˆçº§è°ƒåº¦

### 3. åŠŸè€—ä¼˜åŒ–
- ä½ŽåŠŸè€—æ¨¡å¼æ”¯æŒ
- LEDäº®åº¦è°ƒèŠ‚
- å¾…æœºæ¨¡å¼

## æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

1. **LEDä¸äº®**
   - æ£€æŸ¥GPIOé…ç½®
   - éªŒè¯ç”µè·¯è¿žæŽ¥
   - ç¡®è®¤ç”µæºä¾›åº”

2. **æŒ‰é’®æ— å“åº”**
   - æ£€æŸ¥ä¸Šæ‹‰ç”µé˜»é…ç½®
   - éªŒè¯æŒ‰é’®è¿žæŽ¥
   - æ£€æŸ¥é˜²æŠ–é€»è¾‘

3. **çŠ¶æ€è½¬æ¢å¼‚å¸¸**
   - æ£€æŸ¥å®šæ—¶å™¨é…ç½®
   - éªŒè¯çŠ¶æ€æœºé€»è¾‘
   - æŸ¥çœ‹RTTè°ƒè¯•è¾“å‡º

4. **ç³»ç»Ÿé‡å¯**
   - æ£€æŸ¥çœ‹é—¨ç‹—é…ç½®
   - éªŒè¯æ ˆå¤§å°
   - æ£€æŸ¥å†…å­˜ä½¿ç”¨

### è°ƒè¯•æŠ€å·§

1. **RTTè°ƒè¯•**
   - å®žæ—¶çŠ¶æ€ç›‘æŽ§
   - äº‹ä»¶æ—¥å¿—è®°å½•
   - æ€§èƒ½åˆ†æž

2. **é€»è¾‘åˆ†æžä»ª**
   - ä¿¡å·æ—¶åºåˆ†æž
   - å¤šé€šé“ç›‘æŽ§
   - åè®®è§£æž

3. **ç¤ºæ³¢å™¨**
   - PWMä¿¡å·æµ‹é‡
   - æ—¶åºéªŒè¯
   - ä¿¡å·è´¨é‡åˆ†æž

## ç›¸å…³èµ„æº

- [äº¤é€šä¿¡å·æŽ§åˆ¶ç³»ç»Ÿæ ‡å‡†](https://en.wikipedia.org/wiki/Traffic_light_control_and_coordination)
- [STM32F4 GPIOé…ç½®æŒ‡å—](https://www.st.com/resource/en/reference_manual/dm00031020.pdf)
- [åµŒå…¥å¼çŠ¶æ€æœºè®¾è®¡](https://www.state-machine.com/)
- [å®žæ—¶ç³»ç»Ÿè®¾è®¡åŽŸåˆ™](https://en.wikipedia.org/wiki/Real-time_computing)

---

**è®©äº¤é€šæ›´å®‰å…¨ï¼Œè®©å‡ºè¡Œæ›´é¡ºç•…ï¼** ðŸš¦âœ¨