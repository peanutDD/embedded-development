# UART基础理论

## 概述

UART（Universal Asynchronous Receiver/Transmitter，通用异步收发器）是嵌入式系统中最基础的串行通信接口之一。本文档深入介绍UART的工作原理、硬件特性和软件实现基础。

## UART工作原理

### 基本概念

UART是一种异步串行通信协议，具有以下特点：
- **异步传输**：发送方和接收方不需要共享时钟信号
- **串行传输**：数据按位依次传输
- **全双工**：可以同时进行发送和接收
- **点对点**：通常用于两个设备之间的直接通信

### 数据帧格式

标准UART数据帧包含以下部分：

```
起始位 | 数据位(5-9位) | 校验位(可选) | 停止位(1-2位)
  0   |   D0-D7      |     P       |    1/2
```

#### 各部分详解

1. **起始位（Start Bit）**
   - 固定为逻辑0
   - 标志数据传输开始
   - 持续时间为1个位时间

2. **数据位（Data Bits）**
   - 通常为5-9位，最常用8位
   - LSB（最低有效位）先传输
   - 包含实际要传输的数据

3. **校验位（Parity Bit）**
   - 可选的错误检测位
   - 奇校验：使总的1的个数为奇数
   - 偶校验：使总的1的个数为偶数
   - 无校验：不使用校验位

4. **停止位（Stop Bits）**
   - 固定为逻辑1
   - 标志数据传输结束
   - 可以是1位、1.5位或2位

### 波特率和时序

#### 波特率定义
波特率（Baud Rate）表示每秒传输的符号数，在UART中等于每秒传输的位数。

常用波特率：
- 9600 bps
- 19200 bps
- 38400 bps
- 57600 bps
- 115200 bps
- 230400 bps
- 460800 bps

#### 位时间计算
```
位时间 = 1 / 波特率
例如：115200 bps的位时间 = 1/115200 ≈ 8.68 μs
```

#### 时序容差
UART通信对时钟精度有一定要求：
- 通常要求时钟误差 < ±2%
- 高波特率下要求更高的时钟精度
- 接收方通过起始位边沿进行时钟同步

## 硬件实现

### UART硬件结构

```
发送数据 → [发送移位寄存器] → TX引脚
接收数据 ← [接收移位寄存器] ← RX引脚
           ↑
      [波特率生成器]
           ↑
        [时钟源]
```

#### 主要组件

1. **发送器（Transmitter）**
   - 发送数据寄存器（TDR）
   - 发送移位寄存器（TSR）
   - 发送控制逻辑

2. **接收器（Receiver）**
   - 接收数据寄存器（RDR）
   - 接收移位寄存器（RSR）
   - 接收控制逻辑

3. **波特率生成器**
   - 基于系统时钟生成波特率时钟
   - 通常使用分频器实现
   - 支持多种标准波特率

4. **控制和状态寄存器**
   - 配置寄存器：数据位、校验位、停止位
   - 状态寄存器：发送完成、接收就绪、错误标志

### 电气特性

#### TTL电平（3.3V/5V逻辑）
- 逻辑1：2.4V - 5V（5V系统）或 2.0V - 3.3V（3.3V系统）
- 逻辑0：0V - 0.8V（5V系统）或 0V - 0.8V（3.3V系统）
- 空闲状态：逻辑1（高电平）

#### RS-232电平
- 逻辑1：-3V 到 -15V
- 逻辑0：+3V 到 +15V
- 需要电平转换芯片（如MAX232）

## 软件实现基础

### 基本操作流程

#### 发送数据
```rust
// 伪代码示例
fn uart_send_byte(data: u8) {
    // 等待发送寄存器空
    while !uart.status.tx_empty() {}
    
    // 写入数据到发送寄存器
    uart.data_register = data;
}
```

#### 接收数据
```rust
// 伪代码示例
fn uart_receive_byte() -> Option<u8> {
    // 检查是否有数据可读
    if uart.status.rx_ready() {
        Some(uart.data_register)
    } else {
        None
    }
}
```

### 中断处理

UART通常支持以下中断：
- **发送完成中断**：发送寄存器空时触发
- **接收完成中断**：接收到数据时触发
- **错误中断**：发生帧错误、校验错误等时触发

### 错误处理

常见UART错误类型：
1. **帧错误（Frame Error）**：停止位不正确
2. **校验错误（Parity Error）**：校验位不匹配
3. **溢出错误（Overrun Error）**：接收缓冲区溢出
4. **噪声错误（Noise Error）**：信号质量差

## 性能考虑

### 吞吐量计算

理论最大吞吐量：
```
吞吐量 = 波特率 × 数据位数 / 总帧长度

例如：115200 bps，8数据位，1停止位，无校验
总帧长度 = 1(起始) + 8(数据) + 1(停止) = 10位
吞吐量 = 115200 × 8 / 10 = 92160 bps = 11.52 KB/s
```

### 延迟分析

UART通信延迟包括：
- **传输延迟**：数据在线路上的传播时间
- **处理延迟**：软件处理时间
- **缓冲延迟**：数据在缓冲区中的等待时间

### 优化策略

1. **使用中断驱动**：避免轮询造成的CPU浪费
2. **实现缓冲机制**：减少数据丢失风险
3. **选择合适波特率**：平衡速度和可靠性
4. **错误恢复机制**：提高通信可靠性

## 应用场景

### 典型应用
- **调试接口**：程序调试和日志输出
- **传感器通信**：读取传感器数据
- **设备控制**：控制外部设备
- **数据传输**：设备间数据交换
- **协议网关**：不同协议间的转换

### 优缺点分析

#### 优点
- 实现简单，成本低
- 硬件资源需求少
- 广泛支持，兼容性好
- 适合点对点通信

#### 缺点
- 传输速度相对较低
- 不支持多主设备
- 缺乏内置错误恢复机制
- 长距离传输需要额外处理

## 总结

UART作为最基础的串行通信接口，在嵌入式系统中发挥着重要作用。理解其工作原理、硬件特性和软件实现基础，是掌握更复杂通信协议的前提。在实际应用中，需要根据具体需求选择合适的配置参数，并实现相应的错误处理和优化机制。

## 参考资料

- [UART Protocol Specification](https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter)
- [STM32 UART/USART Reference Manual](https://www.st.com/resource/en/reference_manual/dm00031020.pdf)
- [Embedded Systems UART Design Guidelines](https://www.ti.com/lit/an/slaa522/slaa522.pdf)