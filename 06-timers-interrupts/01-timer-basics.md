# 定时器基础

## 概述

定时器是嵌入式系统中最重要的外设之一，它提供了精确的时间基准和事件触发机制。本章将深入介绍定时器的基本概念、工作原理以及在STM32微控制器中的具体实现。

## 定时器的基本概念

### 什么是定时器

定时器是一个能够按照预设时间间隔产生事件的硬件模块。它通过计数器的方式工作，当计数器达到预设值时，触发相应的事件（如中断、输出翻转等）。

### 定时器的核心组件

1. **计数器（Counter）**
   - 存储当前计数值的寄存器
   - 可以向上计数、向下计数或中心对齐计数

2. **预分频器（Prescaler）**
   - 对输入时钟进行分频
   - 降低计数器的计数频率

3. **自动重载寄存器（Auto-Reload Register, ARR）**
   - 定义计数器的最大值
   - 计数器达到此值时会重新开始计数

4. **比较寄存器（Compare Register）**
   - 用于PWM输出或输出比较功能
   - 当计数器值等于比较值时触发事件

## 定时器的工作模式

### 基本计数模式

1. **向上计数模式**
   ```
   计数器: 0 → 1 → 2 → ... → ARR → 0 → 1 → ...
   ```

2. **向下计数模式**
   ```
   计数器: ARR → ARR-1 → ARR-2 → ... → 0 → ARR → ...
   ```

3. **中心对齐模式**
   ```
   计数器: 0 → 1 → ... → ARR → ARR-1 → ... → 0 → ...
   ```

### 时钟源选择

1. **内部时钟（CK_INT）**
   - 来自系统时钟
   - 最常用的时钟源

2. **外部时钟模式1（ETR引脚）**
   - 通过外部引脚输入时钟
   - 用于外部事件计数

3. **外部时钟模式2（TIx引脚）**
   - 通过定时器输入通道
   - 用于编码器接口等应用

## 定时器的分类

### 按功能分类

1. **基本定时器（Basic Timer）**
   - 只有基本的计数功能
   - 主要用于触发DAC、ADC等
   - 例：TIM6, TIM7

2. **通用定时器（General-purpose Timer）**
   - 具有输入捕获、输出比较、PWM等功能
   - 最常用的定时器类型
   - 例：TIM2, TIM3, TIM4, TIM5

3. **高级定时器（Advanced Timer）**
   - 具有互补输出、死区时间等高级功能
   - 主要用于电机控制
   - 例：TIM1, TIM8

### 按位数分类

1. **16位定时器**
   - 计数范围：0-65535
   - 大部分STM32定时器

2. **32位定时器**
   - 计数范围：0-4294967295
   - 例：TIM2, TIM5（在某些STM32系列中）

## 定时器的时钟计算

### 基本公式

```
定时器频率 = 时钟源频率 / (预分频器 + 1)
定时周期 = (ARR + 1) / 定时器频率
```

### 实际计算示例

假设系统时钟为84MHz，要产生1ms的定时：

```
目标频率 = 1000Hz (1ms周期)
预分频器 = 83 (84MHz / (83+1) = 1MHz)
ARR = 999 (1MHz / (999+1) = 1000Hz)
```

## 定时器中断

### 中断类型

1. **更新中断（Update Interrupt）**
   - 计数器溢出时产生
   - 最常用的定时器中断

2. **比较匹配中断（Compare Match Interrupt）**
   - 计数器值等于比较寄存器值时产生
   - 用于精确时间点触发

3. **捕获中断（Capture Interrupt）**
   - 输入信号边沿触发时产生
   - 用于测量外部信号

### 中断处理流程

```rust
// 中断服务程序示例
#[interrupt]
fn TIM2() {
    // 清除中断标志
    unsafe {
        (*TIM2::ptr()).sr.modify(|_, w| w.uif().clear_bit());
    }
    
    // 执行用户代码
    // ...
}
```

## 定时器的应用场景

### 1. 精确延时
```rust
// 使用定时器实现精确延时
fn delay_ms(ms: u32) {
    // 配置定时器
    // 等待定时器中断
}
```

### 2. 周期性任务
```rust
// 定时器中断中执行周期性任务
static mut COUNTER: u32 = 0;

#[interrupt]
fn TIM2() {
    unsafe {
        COUNTER += 1;
        if COUNTER % 1000 == 0 {
            // 每秒执行一次的任务
        }
    }
}
```

### 3. PWM信号生成
```rust
// 配置定时器生成PWM信号
fn setup_pwm() {
    // 设置ARR和比较值
    // 配置输出模式
}
```

### 4. 输入信号测量
```rust
// 使用输入捕获测量信号周期
fn measure_frequency() {
    // 配置输入捕获
    // 计算两次捕获之间的时间差
}
```

## 定时器配置最佳实践

### 1. 时钟配置
- 合理选择预分频器值
- 避免时钟频率过高导致功耗增加
- 考虑定时精度要求

### 2. 中断优先级
- 根据实时性要求设置中断优先级
- 避免高频中断影响系统性能
- 合理分配中断资源

### 3. 资源管理
- 及时清除中断标志
- 避免在中断中执行耗时操作
- 使用DMA减少CPU负担

## 常见问题和解决方案

### 1. 定时不准确
**原因**：
- 时钟配置错误
- 预分频器计算错误
- 中断处理延迟

**解决方案**：
- 验证时钟树配置
- 重新计算预分频器和ARR值
- 优化中断服务程序

### 2. 中断丢失
**原因**：
- 中断标志未清除
- 中断优先级设置不当
- 中断服务程序执行时间过长

**解决方案**：
- 确保及时清除中断标志
- 调整中断优先级
- 简化中断服务程序

### 3. 功耗过高
**原因**：
- 定时器频率过高
- 不必要的定时器运行

**解决方案**：
- 降低定时器频率
- 在不需要时停止定时器
- 使用低功耗模式

## 总结

定时器是嵌入式系统的核心组件，掌握其基本原理和配置方法对于开发高质量的嵌入式应用至关重要。通过合理的配置和使用，定时器可以为系统提供精确的时间基准和强大的功能支持。

在后续章节中，我们将深入探讨STM32定时器的具体架构和高级应用，包括PWM生成、输入捕获、定时器同步等内容。

## 参考资料

- STM32F4 Reference Manual
- ARM Cortex-M4 Technical Reference Manual
- STM32 Timer Cookbook
- Embedded Systems Programming Best Practices