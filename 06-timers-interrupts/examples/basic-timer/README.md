# 基础定时器示例

本目录包含STM32F4xx基础定时器的完整示例，展示了定时器的各种应用场景和功能。

## 示例列表

### 1. timer_interrupt.rs - 定时器中断示例
演示如何使用多个定时器产生不同频率的中断，并通过LED指示中断状态。

**功能特性：**
- 配置TIM2、TIM3、TIM4定时器以不同频率触发中断
- 使用队列机制处理中断事件
- LED指示不同定时器的中断状态
- 中断统计和性能监控

**硬件连接：**
- PB0: 状态LED（系统运行指示）
- PB1: 定时器1中断指示LED
- PB2: 定时器2中断指示LED
- PB3: 定时器3中断指示LED

### 2. precise_timing.rs - 精确计时示例
展示如何实现微秒级和毫秒级的精确计时测量。

**功能特性：**
- 使用DWT（Data Watchpoint and Trace）计数器进行精确计时
- 微秒级和毫秒级计时演示
- 计时精度测量和误差分析
- 多种计时方法的比较

**硬件连接：**
- PB0: 状态LED
- PB1: 计时指示LED
- PB2: 测量结果LED
- PB3: 错误指示LED
- PC13: 模式切换按钮

**演示模式：**
- 微秒级精确计时（10μs-500μs）
- 毫秒级精确计时（1ms-50ms）
- 计时测量统计
- 计时方法比较

### 3. timer_cascade.rs - 定时器级联示例
演示多个定时器的级联配置和协同工作。

**功能特性：**
- 多定时器级联配置
- 不同级联模式的演示
- 定时器同步和频率分频
- 级联事件处理

**硬件连接：**
- PB0: 状态LED
- PB1: 定时器1状态LED
- PB2: 定时器2状态LED
- PB3: 定时器3状态LED
- PC13: 模式切换按钮

**级联模式：**
- Sequential: 顺序模式（不同频率）
- Parallel: 并行模式（相同频率）
- Synchronized: 同步模式（级联触发）
- Frequency: 频率分频模式

### 4. timer_pwm.rs - 定时器PWM示例
展示如何使用定时器生成PWM信号，实现各种灯光效果。

**功能特性：**
- 4通道PWM输出
- 多种PWM模式和效果
- 实时PWM参数调整
- LED亮度指示

**硬件连接：**
- PA8-PA11: PWM输出引脚（TIM1通道1-4）
- PB0: 状态LED
- PB1-PB3: 通道状态指示LED
- PC13: 模式切换按钮

**PWM模式：**
- Static: 静态输出（固定占空比）
- Breathing: 呼吸灯效果
- Wave: 波浪效果（相位偏移）
- Rainbow: 彩虹效果（HSV颜色空间）

## 编译和运行

### 编译单个示例
```bash
# 编译定时器中断示例
cargo build --bin timer_interrupt

# 编译精确计时示例
cargo build --bin precise_timing

# 编译定时器级联示例
cargo build --bin timer_cascade

# 编译PWM示例
cargo build --bin timer_pwm
```

### 烧录到开发板
```bash
# 烧录定时器中断示例
cargo run --bin timer_interrupt

# 烧录精确计时示例
cargo run --bin precise_timing

# 烧录定时器级联示例
cargo run --bin timer_cascade

# 烧录PWM示例
cargo run --bin timer_pwm
```

## 定时器理论基础

### 定时器工作原理
1. **时钟源选择**：内部时钟、外部时钟、级联时钟
2. **预分频器**：降低计数频率，扩展计时范围
3. **自动重装载寄存器**：定义计数周期
4. **计数模式**：向上计数、向下计数、中心对齐

### 中断机制
1. **更新中断**：计数器溢出时触发
2. **比较中断**：计数值匹配比较寄存器时触发
3. **捕获中断**：外部事件触发输入捕获时产生
4. **中断优先级**：NVIC中断优先级管理

### PWM原理
1. **PWM生成**：比较寄存器与计数器比较产生PWM
2. **占空比控制**：调整比较寄存器值改变占空比
3. **频率设置**：通过预分频器和自动重装载值设置
4. **多通道输出**：单个定时器可产生多路PWM

## 性能分析

### 定时器精度
- **基本精度**：取决于系统时钟频率
- **中断延迟**：中断响应时间影响精度
- **软件开销**：中断处理函数执行时间

### 资源使用
- **内存占用**：中断队列和数据结构
- **CPU占用**：中断处理和计算开销
- **定时器资源**：合理分配定时器资源

## 注意事项

### 硬件注意事项
1. **引脚复用**：确保PWM引脚正确配置为复用功能
2. **时钟配置**：正确配置系统时钟和定时器时钟
3. **中断优先级**：合理设置中断优先级避免冲突
4. **电源管理**：考虑定时器对功耗的影响

### 软件注意事项
1. **中断安全**：中断处理函数要简短高效
2. **数据同步**：主循环和中断间的数据同步
3. **溢出处理**：防止计数器溢出导致的问题
4. **资源释放**：正确释放定时器资源

## 扩展功能

### 高级特性
1. **输入捕获**：测量外部信号的频率和占空比
2. **输出比较**：精确控制输出信号的时序
3. **编码器接口**：连接旋转编码器进行位置检测
4. **死区控制**：电机控制中的安全保护

### 应用场景
1. **电机控制**：PWM调速、步进电机驱动
2. **信号生成**：任意波形生成、频率合成
3. **时间测量**：脉冲宽度测量、频率计数
4. **系统调度**：RTOS时基、任务调度

## 调试技巧

### 常见问题
1. **中断不触发**：检查中断使能和NVIC配置
2. **PWM无输出**：检查引脚复用和通道使能
3. **计时不准确**：检查时钟配置和预分频设置
4. **系统卡死**：检查中断处理函数是否过长

### 调试方法
1. **LED指示**：使用LED显示系统状态
2. **串口输出**：输出调试信息和测量数据
3. **逻辑分析仪**：分析PWM波形和时序
4. **示波器**：测量信号质量和精度

## 相关资源

### 参考文档
- STM32F4xx参考手册
- STM32F4xx-HAL库文档
- Cortex-M4技术参考手册

### 相关示例
- `../pwm-control/`: PWM控制进阶示例
- `../scheduler/`: 任务调度器示例
- `../../projects/motor-driver/`: 电机驱动项目