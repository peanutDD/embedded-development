# 输入捕获示例

本目录包含基于STM32F4xx微控制器的定时器输入捕获功能示例，展示如何使用定时器捕获外部信号的时序特征。

## 示例列表

### 1. 频率计 (frequency_counter.rs)
测量输入信号的频率和周期。

**功能特性：**
- 单通道频率测量
- 多通道频率测量
- 频率范围检测
- 实时频率计算
- 周期测量
- 频率变化检测

**硬件连接：**
```
PA8  -> 输入信号 (TIM1_CH1)
PB0  -> 状态LED
```

### 2. 脉宽测量 (pulse_width_measurement.rs)
测量PWM信号的脉宽和占空比。

**功能特性：**
- PWM信号分析
- 脉宽测量
- 占空比计算
- 多脉冲统计分析
- PWM参数实时监测
- 脉宽变化检测

**硬件连接：**
```
PA8  -> PWM输入信号 (TIM1_CH1)
PA9  -> PWM输入信号 (TIM1_CH2, PWM输入模式)
```

### 3. 超声波距离测量 (ultrasonic_distance.rs)
使用HC-SR04超声波传感器测量距离。

**功能特性：**
- 超声波距离测量
- 多传感器管理
- 距离滤波
- 障碍物检测
- 测量超时处理
- 距离统计分析

**硬件连接：**
```
PA9  -> HC-SR04 Trigger
PA8  -> HC-SR04 Echo (TIM1_CH1)
PB0  -> 状态LED
VCC  -> 5V
GND  -> GND
```

### 4. 编码器读取 (encoder_reader.rs)
读取旋转编码器的位置和速度。

**功能特性：**
- 正交编码器解码
- 位置和角度计算
- 速度测量 (RPM)
- 方向检测
- 双编码器差速驱动
- 编码器校准

**硬件连接：**
```
PA8  -> 编码器A相 (TIM1_CH1)
PA9  -> 编码器B相 (TIM1_CH2)
PB0  -> 状态LED
VCC  -> 3.3V/5V
GND  -> GND
```

## 输入捕获基础知识

### 工作原理
输入捕获功能可以精确测量外部信号的时序特征：
- **上升沿捕获**：检测信号从低到高的跳变
- **下降沿捕获**：检测信号从高到低的跳变
- **双边沿捕获**：同时检测上升沿和下降沿
- **PWM输入模式**：同时测量周期和脉宽

### 测量精度
- **时间分辨率**：取决于定时器时钟频率
- **频率范围**：受定时器计数器位数限制
- **测量误差**：主要来源于时钟精度和中断延迟

## 硬件要求

### 开发板
- STM32F4xx系列开发板
- 支持TIM1定时器的GPIO引脚

### 外部器件
- **频率计**：信号发生器或方波信号源
- **脉宽测量**：PWM信号源
- **超声波测距**：HC-SR04超声波传感器
- **编码器**：增量式旋转编码器

### 连接线材
- 杜邦线若干
- 面包板 (可选)

## 编译和运行

### 编译单个示例
```bash
# 编译频率计示例
cargo build --bin frequency_counter --release

# 编译脉宽测量示例
cargo build --bin pulse_width_measurement --release

# 编译超声波测距示例
cargo build --bin ultrasonic_distance --release

# 编译编码器读取示例
cargo build --bin encoder_reader --release
```

### 烧录程序
```bash
# 使用cargo-flash烧录
cargo flash --bin frequency_counter --chip STM32F401RETx

# 或使用OpenOCD
openocd -f interface/stlink.cfg -f target/stm32f4x.cfg -c "program target/thumbv7em-none-eabihf/release/frequency_counter verify reset exit"
```

### 调试
```bash
# 启动调试会话
cargo embed --bin frequency_counter
```

## 使用说明

### 频率计使用
1. 连接信号源到PA8引脚
2. 烧录程序并运行
3. 观察LED状态指示频率范围
4. 通过调试器查看频率数值

### 脉宽测量使用
1. 连接PWM信号到PA8引脚
2. 运行程序开始测量
3. 程序自动计算脉宽和占空比
4. 支持实时PWM参数监测

### 超声波测距使用
1. 按照接线图连接HC-SR04
2. 确保传感器供电正常
3. 运行程序开始测距
4. LED指示距离状态 (近距离点亮)

### 编码器读取使用
1. 连接编码器A、B相到PA8、PA9
2. 确保编码器供电和接地
3. 运行程序读取位置
4. LED指示旋转方向

## 注意事项

### 信号电平
- 确保输入信号电平与MCU兼容 (3.3V)
- 5V信号需要电平转换电路
- 避免信号电平超过MCU最大输入电压

### 信号质量
- 使用屏蔽线减少干扰
- 添加适当的滤波电路
- 确保信号边沿足够陡峭

### 定时器配置
- 选择合适的预分频器
- 考虑计数器溢出问题
- 合理设置捕获极性

### 中断处理
- 保持中断服务程序简短
- 避免在中断中执行耗时操作
- 正确清除中断标志

## 扩展功能

### 高级测量
- 多通道同步捕获
- 相位差测量
- 信号质量分析
- 频谱分析

### 通信接口
- 串口数据输出
- I2C/SPI传感器接口
- 无线数据传输
- 上位机软件

### 应用集成
- 电机控制反馈
- 机器人导航
- 工业测量
- 科学实验

## 故障排除

### 常见问题
1. **无法捕获信号**
   - 检查引脚连接
   - 确认信号电平
   - 验证定时器配置

2. **测量结果不准确**
   - 检查时钟配置
   - 调整预分频器
   - 考虑信号噪声

3. **程序无响应**
   - 检查中断配置
   - 验证中断服务程序
   - 确认NVIC设置

### 调试技巧
- 使用逻辑分析仪观察信号
- 通过串口输出调试信息
- 使用示波器检查信号质量
- 单步调试中断服务程序