# 中断处理示例

本目录包含了STM32F4xx微控制器中断处理的各种示例，展示了定时器中断、外部中断、优先级管理和中断延迟测量等功能。

## 示例列表

### 1. 基础定时器中断 (basic_timer_interrupt.rs)

演示基本的定时器中断处理，包括中断统计和负载监控。

**功能特性：**
- 1Hz定时器中断触发
- LED状态切换
- 中断计数和统计
- 中断执行时间测量
- 中断负载监控
- 过载检测和回调

**硬件连接：**
```
PB0 -> LED (状态指示)
PB1 -> LED (过载指示)
```

### 2. 外部中断 (external_interrupt.rs)

展示GPIO外部中断处理，包括按钮防抖、长按和双击检测。

**功能特性：**
- GPIO外部中断配置
- 按钮防抖处理
- 长按检测 (>1秒)
- 双击检测 (<500ms间隔)
- 多按钮管理
- 中断事件统计

**硬件连接：**
```
PA0 -> 按钮1 (上拉输入)
PA1 -> 按钮2 (上拉输入)
PA2 -> 按钮3 (上拉输入)
PB0 -> LED1 (状态指示)
PB1 -> LED2 (事件指示)
```

### 3. 优先级管理 (priority_management.rs)

演示中断优先级配置和管理，包括抢占和优先级反转处理。

**功能特性：**
- 多级中断优先级配置
- 高优先级中断抢占
- 优先级反转检测
- 中断嵌套管理
- 事件队列处理
- 优先级统计分析

**中断优先级配置：**
```
TIM2: 优先级0 (最高) - 高优先级任务
TIM3: 优先级1 (中等) - 中等优先级任务
TIM4: 优先级2 (最低) - 低优先级任务
```

### 4. 中断延迟测量 (interrupt_latency.rs)

测量和分析中断响应延迟，提供详细的延迟统计信息。

**功能特性：**
- 高精度延迟测量 (使用DWT计数器)
- 延迟统计分析 (最小值、最大值、平均值、抖动)
- 多中断源延迟比较
- 实时延迟监控
- 延迟阈值告警
- 纳秒级精度显示

**测量方法：**
```
1. 中断触发前记录时间戳
2. 中断服务程序开始时记录时间戳
3. 计算延迟差值
4. 统计分析延迟数据
```

## 编译和运行

### 编译单个示例

```bash
# 编译基础定时器中断示例
cargo build --bin basic_timer_interrupt --release

# 编译外部中断示例
cargo build --bin external_interrupt --release

# 编译优先级管理示例
cargo build --bin priority_management --release

# 编译中断延迟测量示例
cargo build --bin interrupt_latency --release
```

### 烧录到开发板

```bash
# 使用probe-run烧录
cargo run --bin basic_timer_interrupt --release

# 或使用OpenOCD
openocd -f interface/stlink.cfg -f target/stm32f4x.cfg -c "program target/thumbv7em-none-eabihf/release/basic_timer_interrupt verify reset exit"
```

## 中断处理基础知识

### 中断优先级

STM32F4xx支持16个优先级级别（0-15），数字越小优先级越高：

```rust
// 设置中断优先级
unsafe {
    let mut nvic = cortex_m::peripheral::NVIC::steal();
    nvic.set_priority(stm32::Interrupt::TIM2, 0); // 最高优先级
    nvic.set_priority(stm32::Interrupt::TIM3, 1); // 中等优先级
    nvic.set_priority(stm32::Interrupt::TIM4, 2); // 低优先级
}
```

### 中断延迟组成

中断延迟主要由以下部分组成：
1. **硬件延迟**：中断信号到CPU响应
2. **软件延迟**：上下文切换和中断向量跳转
3. **处理延迟**：中断服务程序执行时间

### 中断嵌套

高优先级中断可以抢占低优先级中断：

```rust
// 在中断服务程序中
#[interrupt]
fn TIM2() {
    // 高优先级中断处理
    // 可以被更高优先级中断抢占
}
```

## 硬件要求

- **开发板**：STM32F4 Discovery或兼容板
- **调试器**：ST-Link V2或兼容调试器
- **外设**：LED、按钮、示波器（用于延迟测量）

## 使用说明

### 1. 基础定时器中断测试

1. 连接LED到PB0和PB1
2. 烧录程序
3. 观察LED以1Hz频率闪烁
4. 监控中断统计信息

### 2. 外部中断测试

1. 连接按钮到PA0-PA2（上拉配置）
2. 连接LED到PB0-PB1
3. 烧录程序
4. 测试按钮单击、双击、长按功能

### 3. 优先级管理测试

1. 烧录程序
2. 观察不同优先级中断的执行顺序
3. 监控中断抢占和嵌套情况

### 4. 延迟测量测试

1. 连接示波器到PB0（测试引脚）
2. 烧录程序
3. 测量中断触发到引脚变化的时间
4. 分析延迟统计数据

## 注意事项

### 中断服务程序设计原则

1. **保持简短**：中断服务程序应尽可能短
2. **避免阻塞**：不要在中断中使用延时函数
3. **数据同步**：使用Mutex保护共享数据
4. **优先级设置**：合理设置中断优先级

### 性能优化

1. **减少中断频率**：避免过于频繁的中断
2. **优化ISR代码**：使用高效的算法和数据结构
3. **合理使用DMA**：减少CPU中断负担
4. **监控中断负载**：防止中断过载

### 调试技巧

1. **使用测试引脚**：通过GPIO观察中断时序
2. **统计分析**：收集中断执行时间和频率数据
3. **优先级测试**：验证中断抢占行为
4. **延迟测量**：使用DWT计数器精确测量

## 扩展功能

### 1. 中断负载均衡

```rust
// 动态调整中断优先级
pub fn balance_interrupt_load(&mut self) {
    // 根据中断负载调整优先级
}
```

### 2. 中断事件记录

```rust
// 记录中断事件用于分析
pub struct InterruptEventLogger {
    events: [InterruptEvent; 256],
    index: usize,
}
```

### 3. 实时性能监控

```rust
// 实时监控中断性能
pub struct RealtimeInterruptMonitor {
    latency_threshold: u32,
    violation_count: u32,
}
```

## 故障排除

### 常见问题

1. **中断不触发**
   - 检查中断使能配置
   - 验证NVIC设置
   - 确认中断源配置

2. **中断延迟过大**
   - 检查中断服务程序长度
   - 验证优先级设置
   - 分析中断负载

3. **中断丢失**
   - 检查中断频率
   - 验证中断清除
   - 分析中断嵌套

### 调试方法

1. **使用调试器**：设置断点观察中断执行
2. **添加测试代码**：在关键位置切换GPIO
3. **统计分析**：收集和分析中断数据
4. **示波器测量**：测量实际的中断时序

## 参考资料

- STM32F4xx参考手册
- Cortex-M4技术参考手册
- ARM中断和异常处理指南
- 实时系统设计原理