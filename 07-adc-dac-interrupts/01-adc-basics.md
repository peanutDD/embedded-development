# ADC基础理论

## 概述

模数转换器（ADC，Analog-to-Digital Converter）是嵌入式系统中连接模拟世界和数字世界的关键器件。本章深入探讨ADC的工作原理、性能参数、以及在STM32F4系列微控制器中的具体实现。

## ADC工作原理

### 基本概念

ADC的核心功能是将连续的模拟信号转换为离散的数字信号。这个过程包含三个基本步骤：

1. **采样（Sampling）**：在特定时间点获取模拟信号的瞬时值
2. **量化（Quantization）**：将连续的幅度值映射到有限的数字级别
3. **编码（Encoding）**：将量化后的值表示为二进制数字

### 采样定理

根据奈奎斯特采样定理，为了准确重建原始信号，采样频率必须至少是信号最高频率成分的两倍：

```
fs ≥ 2 × fmax
```

其中：
- fs：采样频率
- fmax：信号的最高频率成分

### 量化过程

对于n位ADC，量化级数为2^n，量化步长（LSB）为：

```
LSB = VREF / 2^n
```

其中：
- VREF：参考电压
- n：ADC位数

## ADC架构类型

### 1. 逐次逼近型ADC（SAR ADC）

STM32F4使用的是SAR ADC架构，具有以下特点：

**工作原理**：
1. 采样保持电路获取输入信号
2. 二分法逐位确定数字输出
3. 每个时钟周期确定一位

**优势**：
- 功耗低
- 转换速度适中
- 成本效益高
- 适合多通道应用

**转换时序**：
```
总转换时间 = 采样时间 + 转换时间
转换时间 = n个ADC时钟周期（n为位数）
```

### 2. 其他ADC架构对比

| 架构类型 | 速度 | 精度 | 功耗 | 成本 | 应用场景 |
|---------|------|------|------|------|----------|
| Flash ADC | 极高 | 中等 | 高 | 高 | 高速采样 |
| Pipeline ADC | 高 | 高 | 中等 | 高 | 视频处理 |
| SAR ADC | 中等 | 高 | 低 | 低 | 通用应用 |
| Sigma-Delta ADC | 低 | 极高 | 低 | 中等 | 精密测量 |

## ADC性能参数

### 1. 静态参数

**分辨率（Resolution）**
- 定义：ADC能够区分的最小输入变化
- 单位：位（bits）
- 计算：n位ADC有2^n个量化级别

**积分非线性（INL）**
- 定义：实际传输特性与理想直线的最大偏差
- 单位：LSB
- 影响：系统精度和线性度

**差分非线性（DNL）**
- 定义：相邻码字对应的模拟输入差值与理想LSB的偏差
- 单位：LSB
- 影响：单调性和缺码

**偏移误差（Offset Error）**
- 定义：零输入时的输出偏差
- 单位：LSB或mV
- 校正：软件或硬件补偿

**增益误差（Gain Error）**
- 定义：满量程输出与理想值的偏差
- 单位：%或LSB
- 校正：增益校准

### 2. 动态参数

**信噪比（SNR）**
- 定义：信号功率与噪声功率的比值
- 单位：dB
- 计算：SNR = 6.02n + 1.76 dB（理论值）

**总谐波失真（THD）**
- 定义：谐波分量功率与基波功率的比值
- 单位：dB
- 影响：信号质量

**有效位数（ENOB）**
- 定义：考虑噪声和失真后的实际分辨率
- 计算：ENOB = (SINAD - 1.76) / 6.02

**建立时间（Settling Time）**
- 定义：输出达到最终值所需的时间
- 影响：最大采样率

## STM32F4 ADC特性

### 硬件特性

**基本规格**：
- 分辨率：12位（4096级）
- 通道数：16个外部 + 3个内部
- 转换速度：最高2.4MSPS
- 参考电压：2.4V - 3.6V

**ADC实例**：
- ADC1：独立ADC，支持所有功能
- ADC2：可与ADC1同步工作
- ADC3：独立ADC，功能与ADC1相同

### 工作模式

**单次转换模式**：
- 触发一次转换后停止
- 适用于偶发性测量

**连续转换模式**：
- 完成一次转换后自动开始下一次
- 适用于连续监测

**扫描模式**：
- 自动扫描多个通道
- 可配置转换顺序

**注入模式**：
- 高优先级转换
- 可中断常规转换

### 触发源

**软件触发**：
- 通过寄存器位启动转换
- 最简单的触发方式

**定时器触发**：
- TIM1/2/3/4/5的TRGO事件
- 实现精确的采样时序

**外部触发**：
- 外部引脚触发
- 适用于同步采样

## 采样时间配置

### 采样时间选择

STM32F4提供8种采样时间选项：
- 3个ADC时钟周期（最快）
- 15个ADC时钟周期
- 28个ADC时钟周期
- 56个ADC时钟周期
- 84个ADC时钟周期
- 112个ADC时钟周期
- 144个ADC时钟周期
- 480个ADC时钟周期（最慢，最精确）

### 采样时间计算

```
采样时间 = 采样周期数 / ADC时钟频率
总转换时间 = 采样时间 + 12个ADC时钟周期
```

### 选择原则

**高阻抗源**：
- 需要较长采样时间
- 推荐≥15个时钟周期

**低阻抗源**：
- 可使用较短采样时间
- 3个时钟周期即可

**精度要求**：
- 高精度：使用较长采样时间
- 高速度：使用较短采样时间

## 参考电压系统

### 参考电压源

**内部参考电压**：
- VREFINT：约1.21V（典型值）
- 温度系数：±50ppm/°C
- 精度：±10mV

**外部参考电压**：
- VREF+引脚输入
- 范围：2.4V - 3.6V
- 推荐使用精密基准源

### 参考电压影响

**转换精度**：
```
实际电压 = (ADC值 / 4095) × VREF
```

**温度漂移**：
- 内部基准：±50ppm/°C
- 外部基准：取决于基准源规格

## 噪声和干扰

### 噪声源

**量化噪声**：
- 理论值：LSB/√12
- 不可避免的基本噪声

**热噪声**：
- 来源：电阻和半导体器件
- 与温度和带宽相关

**电源噪声**：
- 来源：电源纹波和开关噪声
- 通过电源抑制比影响ADC

**时钟抖动**：
- 影响采样时刻精度
- 在高频信号采样时尤为重要

### 噪声抑制方法

**硬件方法**：
1. 使用低噪声电源
2. 添加去耦电容
3. 优化PCB布局
4. 使用差分输入
5. 添加抗混叠滤波器

**软件方法**：
1. 多次采样平均
2. 数字滤波
3. 异常值检测
4. 过采样技术

## 校准技术

### 偏移校准

**步骤**：
1. 将ADC输入接地
2. 进行多次转换
3. 计算平均值作为偏移
4. 在后续测量中减去偏移

**代码示例**：
```rust
// 偏移校准
let mut offset_sum = 0u32;
for _ in 0..100 {
    offset_sum += adc.read(&mut gnd_pin).unwrap() as u32;
}
let offset = (offset_sum / 100) as u16;
```

### 增益校准

**步骤**：
1. 输入已知精确电压
2. 测量ADC输出
3. 计算增益系数
4. 应用增益校正

**计算公式**：
```
增益系数 = 理论ADC值 / 实际ADC值
校正后值 = 原始ADC值 × 增益系数
```

### 多点校准

**线性校准**：
- 使用两个校准点
- 适用于线性度较好的ADC

**多项式校准**：
- 使用多个校准点
- 可补偿非线性误差

**查找表校准**：
- 建立输入输出对应表
- 适用于复杂的非线性特性

## 实际应用考虑

### 输入信号调理

**信号范围匹配**：
- 将输入信号调整到ADC输入范围
- 使用运算放大器进行缩放

**阻抗匹配**：
- 降低源阻抗
- 使用缓冲放大器

**滤波**：
- 抗混叠滤波器
- 噪声滤波

### 采样策略

**采样率选择**：
- 满足奈奎斯特定理
- 考虑处理能力限制

**采样时序**：
- 避免与开关电源同步
- 使用定时器触发保证精确时序

**数据处理**：
- 实时处理vs批处理
- 内存使用优化

## 性能优化

### 速度优化

**减少采样时间**：
- 在满足精度要求下使用最短采样时间
- 优化源阻抗

**使用DMA**：
- 减少CPU干预
- 提高数据传输效率

**并行转换**：
- 使用多个ADC同时工作
- 交替采样提高总采样率

### 精度优化

**过采样**：
- 提高有效分辨率
- 降低噪声影响

**校准**：
- 定期校准补偿漂移
- 温度补偿

**滤波**：
- 硬件滤波 + 软件滤波
- 自适应滤波算法

## 总结

ADC是嵌入式系统中的关键组件，理解其工作原理和性能特性对于设计高质量的数据采集系统至关重要。STM32F4的SAR ADC提供了良好的性能平衡，通过合适的配置和校准技术，可以实现高精度的模拟信号测量。

在实际应用中，需要综合考虑速度、精度、功耗等因素，选择合适的配置参数和优化策略，以满足具体应用的需求。

## 参考资料

1. STM32F4 Reference Manual - ADC章节
2. "Understanding ADCs" - Analog Devices Application Note
3. "ADC Architectures and Choices" - Texas Instruments
4. IEEE Standard 1241-2010 - ADC Testing