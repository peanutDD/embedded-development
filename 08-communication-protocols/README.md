# 08 - I2C/SPI é€šä¿¡åè®®

æœ¬ç« èŠ‚æ·±å…¥å­¦ä¹  I2C å’Œ SPI é€šä¿¡åè®®çš„å®ç°å’Œåº”ç”¨ï¼Œæ¶µç›–ä»åŸºç¡€ç†è®ºåˆ°å®é™…é¡¹ç›®çš„å®Œæ•´å­¦ä¹ è·¯å¾„ã€‚

## ğŸ“š å­¦ä¹ å†…å®¹

### æ ¸å¿ƒåè®®
- **I2C åè®®**: åŒçº¿ä¸²è¡Œé€šä¿¡åè®®ï¼Œæ”¯æŒå¤šä¸»å¤šä»æ¶æ„
- **SPI åè®®**: é«˜é€ŸåŒæ­¥ä¸²è¡Œé€šä¿¡åè®®ï¼Œå…¨åŒå·¥é€šä¿¡
- **åè®®å¯¹æ¯”**: æ€§èƒ½ã€å¤æ‚åº¦ã€åº”ç”¨åœºæ™¯åˆ†æ

### å®è·µæŠ€èƒ½
- å¤šè®¾å¤‡é€šä¿¡ç®¡ç†ä¸ä»²è£
- åè®®è°ƒè¯•æŠ€å·§ä¸æ•…éšœæ’é™¤
- å¸¸è§ä¼ æ„Ÿå™¨æ¥å£é›†æˆ
- æ€§èƒ½ä¼˜åŒ–ä¸é”™è¯¯å¤„ç†

## ğŸ“ ç›®å½•ç»“æ„

```
08-communication-protocols/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶
â”œâ”€â”€ docs/                       # è¯¦ç»†æ–‡æ¡£
â”‚   â”œâ”€â”€ 01-i2c-protocol.md      # I2Cåè®®è¯¦è§£
â”‚   â”œâ”€â”€ 02-spi-protocol.md      # SPIåè®®è¯¦è§£
â”‚   â”œâ”€â”€ 03-protocol-comparison.md # åè®®å¯¹æ¯”åˆ†æ
â”‚   â”œâ”€â”€ 04-debugging-guide.md   # è°ƒè¯•æŒ‡å—
â”‚   â””â”€â”€ 05-sensor-integration.md # ä¼ æ„Ÿå™¨é›†æˆæŒ‡å—
â”œâ”€â”€ examples/                   # ä»£ç ç¤ºä¾‹
â”‚   â”œâ”€â”€ basic-i2c/             # I2CåŸºç¡€ç¤ºä¾‹
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ main.rs         # I2CåŸºç¡€é€šä¿¡
â”‚   â”‚       â”œâ”€â”€ scanner.rs      # I2Cè®¾å¤‡æ‰«æ
â”‚   â”‚       â””â”€â”€ lib.rs
â”‚   â”œâ”€â”€ basic-spi/             # SPIåŸºç¡€ç¤ºä¾‹
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ main.rs         # SPIåŸºç¡€é€šä¿¡
â”‚   â”‚       â”œâ”€â”€ modes.rs        # SPIæ¨¡å¼é…ç½®
â”‚   â”‚       â””â”€â”€ lib.rs
â”‚   â”œâ”€â”€ i2c-eeprom/            # I2C EEPROMæ“ä½œ
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ main.rs         # EEPROMè¯»å†™ç¤ºä¾‹
â”‚   â”‚       â”œâ”€â”€ driver.rs       # EEPROMé©±åŠ¨
â”‚   â”‚       â””â”€â”€ lib.rs
â”‚   â”œâ”€â”€ spi-flash/             # SPI Flashæ“ä½œ
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ main.rs         # Flashè¯»å†™ç¤ºä¾‹
â”‚   â”‚       â”œâ”€â”€ driver.rs       # Flashé©±åŠ¨
â”‚   â”‚       â””â”€â”€ lib.rs
â”‚   â”œâ”€â”€ digital-io/            # æ•°å­—IOæ‰©å±•
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ main.rs         # IOæ‰©å±•ç¤ºä¾‹
â”‚   â”‚       â”œâ”€â”€ pcf8574.rs      # PCF8574é©±åŠ¨
â”‚   â”‚       â””â”€â”€ lib.rs
â”‚   â”œâ”€â”€ multi-device/          # å¤šè®¾å¤‡é€šä¿¡
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ main.rs         # å¤šè®¾å¤‡ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ bus_manager.rs  # æ€»çº¿ç®¡ç†å™¨
â”‚   â”‚       â””â”€â”€ lib.rs
â”‚   â””â”€â”€ protocol-bridge/       # åè®®æ¡¥æ¥
â”‚       â”œâ”€â”€ Cargo.toml
â”‚       â”œâ”€â”€ README.md
â”‚       â””â”€â”€ src/
â”‚           â”œâ”€â”€ main.rs         # I2C-SPIæ¡¥æ¥
â”‚           â”œâ”€â”€ bridge.rs       # æ¡¥æ¥å®ç°
â”‚           â””â”€â”€ lib.rs
â””â”€â”€ projects/                  # å®è·µé¡¹ç›®
    â”œâ”€â”€ sensor-hub/            # ä¼ æ„Ÿå™¨é›†çº¿å™¨
    â”‚   â”œâ”€â”€ Cargo.toml
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ docs/              # é¡¹ç›®æ–‡æ¡£
    â”‚   â”‚   â”œâ”€â”€ architecture.md # æ¶æ„è®¾è®¡
    â”‚   â”‚   â”œâ”€â”€ sensors.md     # ä¼ æ„Ÿå™¨è¯´æ˜
    â”‚   â”‚   â””â”€â”€ api.md         # APIæ–‡æ¡£
    â”‚   â””â”€â”€ src/
    â”‚       â”œâ”€â”€ main.rs         # ä¸»ç¨‹åº
    â”‚       â”œâ”€â”€ sensors/        # ä¼ æ„Ÿå™¨æ¨¡å—
    â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚       â”‚   â”œâ”€â”€ temperature.rs # æ¸©åº¦ä¼ æ„Ÿå™¨
    â”‚       â”‚   â”œâ”€â”€ humidity.rs    # æ¹¿åº¦ä¼ æ„Ÿå™¨
    â”‚       â”‚   â”œâ”€â”€ pressure.rs    # å‹åŠ›ä¼ æ„Ÿå™¨
    â”‚       â”‚   â””â”€â”€ light.rs       # å…‰ç…§ä¼ æ„Ÿå™¨
    â”‚       â”œâ”€â”€ communication/  # é€šä¿¡æ¨¡å—
    â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚       â”‚   â”œâ”€â”€ i2c_manager.rs # I2Cç®¡ç†å™¨
    â”‚       â”‚   â””â”€â”€ spi_manager.rs # SPIç®¡ç†å™¨
    â”‚       â”œâ”€â”€ data/          # æ•°æ®å¤„ç†
    â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚       â”‚   â”œâ”€â”€ collector.rs   # æ•°æ®æ”¶é›†
    â”‚       â”‚   â”œâ”€â”€ processor.rs   # æ•°æ®å¤„ç†
    â”‚       â”‚   â””â”€â”€ storage.rs     # æ•°æ®å­˜å‚¨
    â”‚       â””â”€â”€ lib.rs
    â”œâ”€â”€ display-controller/    # æ˜¾ç¤ºæ§åˆ¶å™¨
    â”‚   â”œâ”€â”€ Cargo.toml
    â”‚   â”œâ”€â”€ README.md
    â”‚   â””â”€â”€ src/
    â”‚       â”œâ”€â”€ main.rs         # æ˜¾ç¤ºæ§åˆ¶ä¸»ç¨‹åº
    â”‚       â”œâ”€â”€ displays/       # æ˜¾ç¤ºè®¾å¤‡
    â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚       â”‚   â”œâ”€â”€ oled.rs     # OLEDæ˜¾ç¤º
    â”‚       â”‚   â”œâ”€â”€ lcd.rs      # LCDæ˜¾ç¤º
    â”‚       â”‚   â””â”€â”€ epaper.rs   # ç”µå­çº¸æ˜¾ç¤º
    â”‚       â”œâ”€â”€ graphics/       # å›¾å½¢å¤„ç†
    â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚       â”‚   â”œâ”€â”€ renderer.rs # æ¸²æŸ“å™¨
    â”‚       â”‚   â””â”€â”€ fonts.rs    # å­—ä½“ç®¡ç†
    â”‚       â””â”€â”€ lib.rs
    â””â”€â”€ iot-gateway/           # IoTç½‘å…³
        â”œâ”€â”€ Cargo.toml
        â”œâ”€â”€ README.md
        â”œâ”€â”€ config/            # é…ç½®æ–‡ä»¶
        â”‚   â”œâ”€â”€ devices.toml   # è®¾å¤‡é…ç½®
        â”‚   â””â”€â”€ network.toml   # ç½‘ç»œé…ç½®
        â””â”€â”€ src/
            â”œâ”€â”€ main.rs         # ç½‘å…³ä¸»ç¨‹åº
            â”œâ”€â”€ devices/        # è®¾å¤‡ç®¡ç†
            â”‚   â”œâ”€â”€ mod.rs
            â”‚   â”œâ”€â”€ manager.rs  # è®¾å¤‡ç®¡ç†å™¨
            â”‚   â””â”€â”€ registry.rs # è®¾å¤‡æ³¨å†Œè¡¨
            â”œâ”€â”€ protocols/      # åè®®å¤„ç†
            â”‚   â”œâ”€â”€ mod.rs
            â”‚   â”œâ”€â”€ i2c.rs      # I2Cåè®®å¤„ç†
            â”‚   â”œâ”€â”€ spi.rs      # SPIåè®®å¤„ç†
            â”‚   â””â”€â”€ uart.rs     # UARTåè®®å¤„ç†
            â”œâ”€â”€ network/        # ç½‘ç»œé€šä¿¡
            â”‚   â”œâ”€â”€ mod.rs
            â”‚   â”œâ”€â”€ wifi.rs     # WiFié€šä¿¡
            â”‚   â””â”€â”€ mqtt.rs     # MQTTåè®®
            â””â”€â”€ lib.rs
```

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬ç« èŠ‚åï¼Œä½ å°†èƒ½å¤Ÿï¼š

### åŸºç¡€èƒ½åŠ›
- âœ… ç†è§£ I2C å’Œ SPI åè®®çš„å·¥ä½œåŸç†
- âœ… æŒæ¡åè®®çš„ç”µæ°”ç‰¹æ€§å’Œæ—¶åºè¦æ±‚
- âœ… å®ç°åŸºæœ¬çš„è¯»å†™æ“ä½œ

### è¿›é˜¶æŠ€èƒ½
- âœ… å¤„ç†å¤šè®¾å¤‡é€šä¿¡åœºæ™¯å’Œæ€»çº¿ä»²è£
- âœ… å®ç°é”™è¯¯æ£€æµ‹å’Œæ¢å¤æœºåˆ¶
- âœ… ä¼˜åŒ–é€šä¿¡æ€§èƒ½å’ŒåŠŸè€—

### å®è·µé¡¹ç›®
- âœ… é›†æˆå¸¸è§ä¼ æ„Ÿå™¨å’Œæ‰§è¡Œå™¨
- âœ… æ„å»ºå¤æ‚çš„é€šä¿¡ç³»ç»Ÿ
- âœ… å¼€å‘å¯é‡ç”¨çš„é©±åŠ¨ç¨‹åº

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd 08-communication-protocols

# å®‰è£…ä¾èµ–
cargo check

# è¿è¡ŒåŸºç¡€ç¤ºä¾‹
cd examples/basic-i2c
cargo run --example scanner

cd ../basic-spi
cargo run --example loopback
```

### å­¦ä¹ è·¯å¾„

#### 1ï¸âƒ£ åŸºç¡€ç†è®ºå­¦ä¹ 
- é˜…è¯» [I2Cåè®®è¯¦è§£](docs/01-i2c-protocol.md)
- é˜…è¯» [SPIåè®®è¯¦è§£](docs/02-spi-protocol.md)
- å­¦ä¹  [åè®®å¯¹æ¯”åˆ†æ](docs/03-protocol-comparison.md)

#### 2ï¸âƒ£ åŸºç¡€ç¤ºä¾‹å®è·µ
```bash
# I2CåŸºç¡€ç¤ºä¾‹
cd examples/basic-i2c
cargo run                    # åŸºç¡€é€šä¿¡
cargo run --bin scanner      # è®¾å¤‡æ‰«æ

# SPIåŸºç¡€ç¤ºä¾‹
cd examples/basic-spi
cargo run                    # åŸºç¡€é€šä¿¡
cargo run --bin modes        # æ¨¡å¼é…ç½®
```

#### 3ï¸âƒ£ è®¾å¤‡é©±åŠ¨å¼€å‘
```bash
# EEPROMé©±åŠ¨
cd examples/i2c-eeprom
cargo run --example read_write

# Flashé©±åŠ¨
cd examples/spi-flash
cargo run --example sector_erase
```

#### 4ï¸âƒ£ ç»¼åˆé¡¹ç›®å®è·µ
```bash
# ä¼ æ„Ÿå™¨é›†çº¿å™¨
cd projects/sensor-hub
cargo run

# æ˜¾ç¤ºæ§åˆ¶å™¨
cd projects/display-controller
cargo run --example oled_demo

# IoTç½‘å…³
cd projects/iot-gateway
cargo run
```

## ğŸ“Š åè®®å¯¹æ¯”

| ç‰¹æ€§ | I2C | SPI | å¤‡æ³¨ |
|------|-----|-----|------|
| **çº¿æ•°** | 2çº¿ (SDA, SCL) | 4çº¿+ (MOSI, MISO, SCK, CS) | SPIéœ€è¦æ›´å¤šGPIO |
| **é€Ÿåº¦** | æ ‡å‡†100kHz, å¿«é€Ÿ400kHz, é«˜é€Ÿ3.4MHz | é€šå¸¸MHzçº§åˆ« | SPIé€Ÿåº¦æ›´å¿« |
| **è®¾å¤‡æ•°** | ç†è®º127ä¸ª | å—CSå¼•è„šé™åˆ¶ | I2Cæ”¯æŒæ›´å¤šè®¾å¤‡ |
| **å¤æ‚åº¦** | è¾ƒå¤æ‚ | ç›¸å¯¹ç®€å• | I2Céœ€è¦åœ°å€ç®¡ç† |
| **åŠŸè€—** | è¾ƒä½ | è¾ƒé«˜ | I2Cå¼€æ¼è¾“å‡ºæ›´çœç”µ |
| **è·ç¦»** | çŸ­è·ç¦» | çŸ­è·ç¦» | éƒ½é€‚åˆPCBå†…é€šä¿¡ |

## ğŸ› ï¸ å¼€å‘å·¥å…·

### ç¡¬ä»¶å·¥å…·
- **é€»è¾‘åˆ†æä»ª**: åè®®æ—¶åºåˆ†æ
- **ç¤ºæ³¢å™¨**: ä¿¡å·è´¨é‡æ£€æŸ¥
- **I2C/SPIè°ƒè¯•å™¨**: ä¸“ç”¨åè®®è°ƒè¯•å·¥å…·

### è½¯ä»¶å·¥å…·
- **probe-rs**: RuståµŒå…¥å¼è°ƒè¯•
- **RTT**: å®æ—¶ä¼ è¾“è°ƒè¯•
- **defmt**: é«˜æ•ˆæ—¥å¿—è®°å½•

## ğŸ”§ è°ƒè¯•æŠ€å·§

### å¸¸è§é—®é¢˜
1. **I2Cé€šä¿¡å¤±è´¥**
   - æ£€æŸ¥ä¸Šæ‹‰ç”µé˜» (é€šå¸¸4.7kÎ©)
   - éªŒè¯è®¾å¤‡åœ°å€
   - ç¡®è®¤æ—¶é’Ÿé¢‘ç‡

2. **SPIæ•°æ®é”™è¯¯**
   - æ£€æŸ¥æ—¶é’Ÿææ€§å’Œç›¸ä½
   - éªŒè¯ç‰‡é€‰ä¿¡å·æ—¶åº
   - ç¡®è®¤æ•°æ®ä½åº

3. **å¤šè®¾å¤‡å†²çª**
   - å®ç°æ€»çº¿ä»²è£
   - æ·»åŠ é‡è¯•æœºåˆ¶
   - ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤

### è°ƒè¯•æµç¨‹
```rust
// å¯ç”¨è°ƒè¯•æ—¥å¿—
use defmt_rtt as _;
use panic_probe as _;

// I2Cè°ƒè¯•ç¤ºä¾‹
defmt::info!("Scanning I2C bus...");
for addr in 0x08..=0x77 {
    if i2c.write(addr, &[]).is_ok() {
        defmt::info!("Found device at 0x{:02X}", addr);
    }
}
```

## ğŸ“š å­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [I2Cè§„èŒƒ v6.0](https://www.nxp.com/docs/en/user-guide/UM10204.pdf)
- [SPIåè®®ä»‹ç»](https://www.analog.com/en/analog-dialogue/articles/introduction-to-spi-interface.html)
- [STM32 I2Cå‚è€ƒæ‰‹å†Œ](https://www.st.com/resource/en/reference_manual/rm0090-stm32f405415-stm32f407417-stm32f427437-and-stm32f429439-advanced-armbased-32bit-mcus-stmicroelectronics.pdf)

### å¼€æºé¡¹ç›®
- [embedded-hal](https://github.com/rust-embedded/embedded-hal) - RuståµŒå…¥å¼HAL
- [stm32f4xx-hal](https://github.com/stm32-rs/stm32f4xx-hal) - STM32F4 HALå®ç°
- [shared-bus](https://github.com/Rahix/shared-bus) - æ€»çº¿å…±äº«åº“

### åœ¨çº¿å·¥å…·
- [I2Cåœ°å€è®¡ç®—å™¨](https://www.i2c-bus.org/addressing/)
- [SPIæ—¶åºç”Ÿæˆå™¨](https://www.analog.com/en/design-center/interactive-design-tools/spi-timing-diagram-tool.html)

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤é—®é¢˜æŠ¥å‘Šã€åŠŸèƒ½è¯·æ±‚å’Œä»£ç è´¡çŒ®ï¼š

1. **é—®é¢˜æŠ¥å‘Š**: è¯¦ç»†æè¿°é—®é¢˜å’Œå¤ç°æ­¥éª¤
2. **åŠŸèƒ½è¯·æ±‚**: è¯´æ˜éœ€æ±‚å’Œä½¿ç”¨åœºæ™¯
3. **ä»£ç è´¡çŒ®**: éµå¾ªé¡¹ç›®ç¼–ç è§„èŒƒ
4. **æ–‡æ¡£æ”¹è¿›**: ä¿®æ­£é”™è¯¯æˆ–æ·»åŠ ç¤ºä¾‹

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](../LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

---

**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024å¹´  
**ç»´æŠ¤è€…**: åµŒå…¥å¼Rustå­¦ä¹ å°ç»„