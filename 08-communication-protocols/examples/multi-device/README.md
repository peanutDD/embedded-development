# 多设备通信示例

本示例演示如何在单个微控制器上管理多个I2C和SPI设备，实现高效的总线管理和设备协调。

## 功能特性

- **多总线管理**: 同时管理I2C和SPI总线
- **设备发现**: 自动扫描和识别总线上的设备
- **资源调度**: 智能的总线访问调度和冲突避免
- **错误恢复**: 完善的通信错误检测和恢复机制
- **性能监控**: 实时监控总线使用率和设备状态
- **优先级管理**: 支持设备访问优先级设置
- **并发控制**: 安全的多设备并发访问控制

## 硬件连接

### I2C设备连接
```
设备类型        地址    STM32F4连接
PCF8574        0x20    SDA->PB7, SCL->PB6
AT24C256       0x50    SDA->PB7, SCL->PB6
DS3231 RTC     0x68    SDA->PB7, SCL->PB6
BMP280         0x76    SDA->PB7, SCL->PB6
```

### SPI设备连接
```
设备类型        CS引脚   STM32F4连接
W25Q128        PA4      MOSI->PA7, MISO->PA6, SCK->PA5
MCP3008        PA8      MOSI->PA7, MISO->PA6, SCK->PA5
MAX7219        PA9      MOSI->PA7, MISO->PA6, SCK->PA5
```

### 控制引脚
```
功能           引脚     说明
状态LED        PC13     系统状态指示
错误LED        PC14     错误状态指示
总线选择       PC0-PC2  总线选择开关
复位按键       PA0      系统复位按键
```

## 代码结构

- `main.rs`: 主程序，演示多设备管理
- `bus_manager.rs`: 总线管理器实现
- `lib.rs`: 库文件，导出公共接口

## 使用方法

1. 连接硬件设备
2. 编译并烧录程序：
   ```bash
   cargo run --bin main
   ```

## 示例功能

### 1. 设备发现和初始化
- 自动扫描I2C和SPI总线
- 识别连接的设备类型
- 初始化设备配置

### 2. 总线调度
- 基于优先级的设备访问调度
- 总线冲突检测和避免
- 动态负载均衡

### 3. 数据采集
- 从多个传感器同时采集数据
- 数据缓存和批处理
- 实时数据流处理

### 4. 设备控制
- LED矩阵显示控制
- EEPROM数据存储
- RTC时间同步

### 5. 错误处理
- 设备离线检测
- 通信错误恢复
- 系统健康监控

## 总线管理策略

### I2C总线管理
- **地址冲突检测**: 自动检测地址冲突
- **时钟拉伸处理**: 支持慢速设备的时钟拉伸
- **多主机仲裁**: 处理多主机总线仲裁
- **错误恢复**: 总线锁定检测和恢复

### SPI总线管理
- **CS引脚管理**: 智能的片选信号管理
- **时钟配置**: 根据设备特性动态调整时钟
- **DMA传输**: 支持DMA加速数据传输
- **全双工通信**: 优化的全双工数据交换

## 性能优化

1. **批量操作**: 合并多个小操作为批量操作
2. **缓存机制**: 智能的数据缓存策略
3. **异步处理**: 非阻塞的设备访问
4. **资源池**: 预分配的资源池管理
5. **优先级队列**: 基于优先级的任务调度

## 注意事项

1. 确保所有设备的电源电压兼容
2. I2C总线需要适当的上拉电阻
3. SPI设备的时钟极性和相位要正确配置
4. 长线连接时注意信号完整性
5. 合理设置设备访问优先级