# Protocol Bridge Example

这个示例演示了如何实现I2C-SPI协议桥接，允许I2C设备与SPI设备之间进行通信。

## 功能特性

### 协议桥接
- **I2C到SPI桥接**: 将I2C命令转换为SPI操作
- **SPI到I2C桥接**: 将SPI数据转换为I2C传输
- **双向通信**: 支持读写操作的双向转换
- **地址映射**: 灵活的设备地址映射机制

### 数据处理
- **格式转换**: 自动处理不同协议的数据格式
- **缓冲管理**: 智能的数据缓冲和队列管理
- **错误检测**: CRC校验和数据完整性检查
- **流控制**: 防止数据溢出的流控制机制

### 设备管理
- **设备注册**: 动态设备注册和配置
- **状态监控**: 实时设备状态监控
- **错误恢复**: 自动错误检测和恢复
- **性能优化**: 传输速度和延迟优化

## 硬件连接

### I2C设备 (作为从设备)
- **SCL**: PB6 (I2C1_SCL)
- **SDA**: PB7 (I2C1_SDA)
- **地址**: 0x48 (可配置)

### SPI设备 (作为主设备)
- **SCK**: PA5 (SPI1_SCK)
- **MISO**: PA6 (SPI1_MISO)
- **MOSI**: PA7 (SPI1_MOSI)
- **CS1**: PA4 (设备1片选)
- **CS2**: PA3 (设备2片选)

### 控制引脚
- **状态LED**: PC13
- **错误LED**: PC14
- **活动LED**: PC15
- **复位按键**: PA0

## 代码结构

```
src/
├── main.rs              # 主程序
├── lib.rs               # 库接口
├── bridge.rs            # 协议桥接核心
├── i2c_slave.rs         # I2C从设备实现
├── spi_master.rs        # SPI主设备实现
└── protocol.rs          # 协议定义和转换
```

## 使用方法

1. **连接硬件**: 按照上述引脚定义连接I2C和SPI设备
2. **编译程序**: `cargo build --release`
3. **烧录程序**: `cargo run --release`
4. **测试通信**: 使用I2C主设备发送命令，观察SPI设备响应

## 示例功能

### 基本桥接
- I2C写命令 → SPI写操作
- I2C读命令 → SPI读操作
- 地址转换和数据格式化

### 高级功能
- 批量数据传输
- 异步操作处理
- 错误状态报告
- 性能统计信息

## 协议格式

### I2C命令格式
```
[设备地址][寄存器地址][数据长度][数据...]
```

### SPI转换格式
```
[命令字节][地址字节][数据字节...]
```

## 注意事项

1. **时序要求**: 确保I2C和SPI时序匹配
2. **电平兼容**: 检查设备电平兼容性
3. **缓冲大小**: 根据数据量调整缓冲区大小
4. **错误处理**: 实现完善的错误处理机制