# FreeRTOS 任务管理示例

这是一个展示 FreeRTOS 任务管理功能的示例项目，演示了多任务创建、优先级管理、任务间通信和系统监控。

## 功能特性

- **多任务管理**: 创建和管理多个并发任务
- **优先级调度**: 展示不同优先级任务的调度行为
- **任务间通信**: 使用队列进行任务间数据传递
- **系统监控**: 实时监控系统状态和资源使用
- **错误处理**: 栈溢出和内存分配失败的处理机制
- **钩子函数**: 实现各种系统钩子函数

## 硬件要求

- STM32F401 开发板 (或兼容的 STM32F4 系列)
- 用户LED 连接到 PA5 引脚
- 内置LED 连接到 PC13 引脚

## 任务架构

### 任务列表

| 任务名称 | 优先级 | 栈大小 | 功能描述 |
|---------|--------|--------|----------|
| SystemMonitor | 4 (最高) | 512字节 | 系统状态监控和健康检查 |
| DataProducer | 3 | 512字节 | 数据生产和队列写入 |
| DataConsumer | 2 | 512字节 | 数据消费和处理 |
| LedBlinker | 1 (最低) | 256字节 | LED闪烁指示 |

### 任务交互

```
┌─────────────────┐    队列    ┌─────────────────┐
│  DataProducer   │ ---------> │  DataConsumer   │
│   (优先级 3)     │            │   (优先级 2)     │
└─────────────────┘            └─────────────────┘
         │                              │
         │                              │
         v                              v
┌─────────────────┐            ┌─────────────────┐
│ SystemMonitor   │            │   LedBlinker    │
│   (优先级 4)     │            │   (优先级 1)     │
└─────────────────┘            └─────────────────┘
```

## 工作流程

### 1. 数据生产者任务 (DataProducer)
- **周期**: 每100ms
- **功能**: 生成递增计数器数据并放入队列
- **优先级**: 3 (高)

### 2. 数据消费者任务 (DataConsumer)
- **周期**: 每50ms
- **功能**: 从队列读取数据并处理
- **特殊行为**: 当数据是10的倍数时，闪烁用户LED
- **优先级**: 2 (中)

### 3. LED闪烁任务 (LedBlinker)
- **周期**: 每500ms
- **功能**: 切换内置LED状态
- **优先级**: 1 (低)

### 4. 系统监控任务 (SystemMonitor)
- **周期**: 每1秒
- **功能**: 
  - 监控系统健康状态
  - 检查任务数量和内存使用
  - 每10个周期用户LED快闪3次表示系统正常
- **优先级**: 4 (最高)

## 系统特性

### 内存管理
- **堆大小**: 8KB
- **分配器**: linked_list_allocator
- **栈监控**: 检测栈溢出

### 队列通信
- **队列大小**: 16个元素
- **数据类型**: u32
- **实现**: heapless::spsc (单生产者单消费者)

### 钩子函数
- `vApplicationStackOverflowHook`: 栈溢出处理
- `vApplicationMallocFailedHook`: 内存分配失败处理
- `vApplicationIdleHook`: 空闲任务钩子
- `vApplicationTickHook`: 系统滴答钩子

## 编译和运行

### 前提条件

```bash
# 安装目标架构
rustup target add thumbv7em-none-eabihf

# 安装调试工具
cargo install probe-run
```

### 编译项目

```bash
cd examples/freertos_tasks
cargo build --release
```

### 烧录和运行

```bash
# 使用 probe-run
cargo run --release

# 或使用 OpenOCD
openocd -f interface/stlink.cfg -f target/stm32f4x.cfg
```

## 预期行为

### LED指示
1. **内置LED (PC13)**: 每500ms闪烁一次 (LedBlinker任务)
2. **用户LED (PA5)**: 
   - 当处理的数据是10的倍数时短暂点亮
   - 每10秒快闪3次表示系统监控正常

### 任务调度
1. **高优先级抢占**: SystemMonitor可以抢占所有其他任务
2. **数据流**: DataProducer -> 队列 -> DataConsumer
3. **低优先级执行**: LedBlinker在其他任务空闲时执行

## 学习要点

### FreeRTOS核心概念

1. **任务创建**: 使用`Task::new()`创建任务
2. **优先级管理**: `TaskPriority`设置任务优先级
3. **任务延时**: `CurrentTask::delay()`实现任务延时
4. **资源共享**: 使用全局静态变量和unsafe代码

### 最佳实践

1. **任务设计**: 每个任务有明确的职责
2. **优先级分配**: 根据实时性要求合理分配
3. **内存管理**: 监控栈和堆使用情况
4. **错误处理**: 实现完整的错误处理机制

## 性能分析

### 任务执行时间
- DataProducer: ~1ms (队列操作)
- DataConsumer: ~2ms (数据处理)
- LedBlinker: ~0.1ms (GPIO操作)
- SystemMonitor: ~5ms (系统检查)

### 内存使用
- 总栈空间: 1792字节 (4个任务)
- 堆空间: 8KB
- 队列空间: 64字节 (16 × 4字节)

## 扩展建议

### 功能扩展
1. **添加更多通信机制**: 信号量、互斥锁、事件组
2. **实现软件定时器**: 替代任务延时
3. **添加中断处理**: 外部中断与任务交互
4. **实现任务通知**: 轻量级任务间通信

### 性能优化
1. **优化任务优先级**: 根据实际需求调整
2. **减少上下文切换**: 合并相关操作
3. **内存池管理**: 预分配固定大小内存块
4. **中断延迟处理**: 将耗时操作移到任务中

## 故障排除

### 常见问题

1. **编译错误**
   - 检查FreeRTOS依赖版本
   - 确认目标架构配置

2. **运行时错误**
   - 栈溢出: 增加任务栈大小
   - 内存不足: 增加堆大小或优化内存使用

3. **任务调度问题**
   - 检查优先级设置
   - 确认任务延时配置

### 调试技巧

1. **使用钩子函数**: 监控系统状态
2. **添加调试输出**: 使用RTT或UART
3. **任务统计**: 监控任务执行时间和CPU使用率
4. **内存分析**: 跟踪内存分配和释放

## 相关资源

- [FreeRTOS 官方文档](https://www.freertos.org/)
- [FreeRTOS Rust 绑定](https://github.com/lobaro/FreeRTOS-rust)
- [STM32F4xx HAL 文档](https://docs.rs/stm32f4xx-hal/)
- [嵌入式 Rust 书籍](https://docs.rust-embedded.org/book/)